<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hệ thống khóa cửa thông minh</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="text-center mb-5">🔐 Hệ thống khóa cửa thông minh</h1>

    <div class="row g-4">
      <!-- Camera stream -->
      <div class="col-lg-6">
        <div class="card shadow">
          <div class="card-header bg-dark text-white">
            📹 Camera an ninh
          </div>
          <div class="card-body text-center">
            <img src="{{ url_for('video_feed') }}" alt="Video Stream" class="img-fluid rounded border border-dark">
          </div>
        </div>
      </div>

      <!-- Identity & Status -->
      <div class="col-lg-6 d-flex flex-column gap-4">
        <!-- Identity -->
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            🚹 Danh tính nhận diện được
          </div>
          <div class="card-body text-center">
            <img id="recognized-image" src="/recognized_identity_image/0" alt="Recognized Face" class="img-fluid rounded border border-success">
          </div>
        </div>

        <!-- Status -->
        <div class="card shadow text-center">
          <div class="card-header bg-info text-white">
            Trạng thái cửa
          </div>
          <div class="card-body">
            <h3 id="doorStatus" class="fw-bold text-secondary">Đóng cửa</h3>
            <div class="d-flex justify-content-center gap-3 mt-4">
              <a href="{{ url_for('traffic_monitor') }}" class="btn btn-outline-secondary">📋 Nhật ký truy cập</a>
              <a href="{{ url_for('add_user') }}" class="btn btn-outline-primary">⬆️ Thêm thành viên</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS for SSE updates -->
  <script>
    const evtSource = new EventSource("/sse/updates");

    evtSource.addEventListener("user", function(event) {
      const userId = parseInt(event.data);
      const imgEl = document.getElementById("recognized-image");
      if (imgEl) {
        imgEl.src = `/recognized_identity_image/${userId}?t=${Date.now()}`; // cache-busting
      }
    });

    evtSource.addEventListener("door", function(event) {
      const doorStatus = event.data;
      const statusEl = document.getElementById("doorStatus");
      if (statusEl) {
        statusEl.textContent = doorStatus === 'OPEN' ? '🚪 Mở cửa' : '🔒 Đóng cửa';
        statusEl.className = doorStatus === 'OPEN'
          ? 'fw-bold text-success'
          : 'fw-bold text-danger';
      }
    });
  </script>
</body>
</html>
