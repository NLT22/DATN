<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Há»‡ thá»‘ng khÃ³a cá»­a thÃ´ng minh</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #recognized-image {
      width: 100%;
      height: 250px;
      width: 250px;
      object-fit: contain;
      border: 2px solid #198754; /* green border */
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-5">
      <h1>ğŸ” Há»‡ thá»‘ng khÃ³a cá»­a thÃ´ng minh</h1>
      {% if session.admin_logged_in %}
        <div class="btn-group">
          <a href="{{ url_for('change_password') }}" class="btn btn-outline-primary">Äá»•i máº­t kháº©u</a>
          <a href="{{ url_for('logout') }}" class="btn btn-primary">ÄÄƒng xuáº¥t</a>
        </div>
      {% else %}
        <a href="{{ url_for('login') }}" class="btn btn-outline-primary">ÄÄƒng nháº­p</a>
      {% endif %}
    </div>

    <div class="row g-4">
      <!-- Camera stream -->
      <div class="col-lg-9">
        <div class="card shadow">
          <div class="card-header bg-dark text-white">
            ğŸ“¹ Camera an ninh
          </div>
          <div class="card-body text-center">
            <img src="{{ url_for('video_feed') }}" alt="Video Stream" class="img-fluid rounded border border-dark">
          </div>
        </div>
      </div>

      <!-- Identity & Status -->
      <div class="col-lg-3 d-flex flex-column gap-4">
        <!-- Identity -->
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            ğŸš¹ Danh tÃ­nh nháº­n diá»‡n Ä‘Æ°á»£c
          </div>
          <div class="card-body text-center">
            <img id="recognized-image" src="/recognized_identity_image/0" alt="Recognized Face">
          </div>
        </div>

        <!-- Status -->
        <div class="card shadow">
          <div class="card-header bg-primary text-white">
            Tráº¡ng thÃ¡i cá»­a
          </div>
          <div class="card-body">
            <h3 id="doorStatus" class="fw-bold text-secondary text-center">ğŸ”’ ÄÃ³ng cá»­a</h3>
            <div class="d-grid gap-3 mt-4">
              <a href="{{ url_for('traffic_monitor') }}" class="btn btn-outline-primary">ğŸ“‹ Nháº­t kÃ½ truy cáº­p</a>
              <a href="{{ url_for('manage_users') }}" class="btn btn-outline-primary">ğŸ›— Quáº£n lÃ½ thÃ nh viÃªn</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS for SSE updates -->
  <script>
    const evtSource = new EventSource("/sse/updates");

    evtSource.addEventListener("user", function(event) {
      const userId = parseInt(event.data);
      const imgEl = document.getElementById("recognized-image");
      if (imgEl) {
        imgEl.src = `/recognized_identity_image/${userId}?t=${Date.now()}`; // cache-busting
      }
    });

    evtSource.addEventListener("door", function(event) {
      const doorStatus = event.data;
      const statusEl = document.getElementById("doorStatus");
      if (statusEl) {
        statusEl.textContent = doorStatus === 'OPEN' ? 'ğŸšª Má»Ÿ cá»­a' : 'ğŸ”’ ÄÃ³ng cá»­a';
        statusEl.className = doorStatus === 'OPEN'
          ? 'fw-bold text-success text-center'
          : 'fw-bold text-danger text-center';
      }
    });
  </script>
</body>
</html>
